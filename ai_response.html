<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Call Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .loading {
            display: none;
            margin-top: 20px;
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .suggestion-button {
            margin: 5px;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .suggestion-button:hover {
            background-color: #2980b9;
        }
        .link {
            margin-top: 10px;
            display: block;
            color: #3498db;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">Upload Image or Enter Ingredients</h1>

        <div class="mb-3">
            <label for="inputType" class="form-label">Select Input Type:</label>
            <select id="inputType" class="form-select">
                <option value="image">Image</option>
                <option value="ingredient_list">Ingredient List</option>
            </select>
        </div>

        <div id="imageInput" class="input-section mb-3">
            <label for="fileInput" class="form-label">Upload Image:</label>
            <input type="file" id="fileInput" class="form-control" accept="image/*">
        </div>

        <div id="ingredientInput" class="input-section hidden mb-3">
            <label for="ingredientTextInput" class="form-label">Enter Ingredients:</label>
            <input type="text" id="ingredientTextInput" class="form-control" placeholder="Enter ingredients (comma-separated)">
        </div>

        <button class="btn btn-primary w-100" onclick="uploadData()">Submit</button>

        <div id="loading" class="loading hidden mt-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div id="results" class="mt-4 p-3 bg-white border rounded"></div>
    </div>

    <script>
        let analysisId = '';
    
        document.getElementById('inputType').addEventListener('change', function () {
            const selectedValue = this.value;
            document.getElementById('imageInput').classList.toggle('hidden', selectedValue !== 'image');
            document.getElementById('ingredientInput').classList.toggle('hidden', selectedValue !== 'ingredient_list');
        });
    
        function uploadData() {
            const inputType = document.getElementById('inputType').value;
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const formData = new FormData();
        
            loading.classList.remove('hidden');
            resultsDiv.innerHTML = '';
        
            if (inputType === 'image') {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files.length) {
                    alert('Please select an image file.');
                    loading.classList.add('hidden');
                    return;
                }
                formData.append('image_or_ingredient_list', 'image');
                formData.append('image', fileInput.files[0]);
            } else if (inputType === 'ingredient_list') {
                const ingredientInput = document.getElementById('ingredientTextInput');
                const ingredients = ingredientInput.value.trim();
                if (!ingredients) {
                    alert('Please enter ingredients.');
                    loading.classList.add('hidden');
                    return;
                }
                formData.append('image_or_ingredient_list', 'ingredient_list');
                formData.append('ingredient_list', ingredients);
            }
        
            fetch('https://ai-utu2.onrender.com/process', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    loading.classList.add('hidden');
        
                    if (data.error) {
                        resultsDiv.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                    } else {
                        analysisId = data.analysis_id;
        
                        // Populate the Analysis Result as an ordered list
                        const analysisItems = data.response
                            .split('\n') // Assuming response is line-separated
                            .filter(line => line.trim()) // Remove empty lines
                            .map((item, index) => `<li>${item.trim()}</li>`)
                            .join('');
        
                        resultsDiv.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title">Analysis Result</h5>
                                            <ol>${analysisItems}</ol>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-4 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title">Food Suggestions</h5>
                                            <div id="suggestions" class="d-flex flex-wrap gap-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card mb-4 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title">Analysis ID</h5>
                                            <p>${data.analysis_id}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
        
                        // Populate Food Suggestions as buttons
                        const suggestionsDiv = document.getElementById('suggestions');
                        data.food_suggestions.forEach(suggestion => {
                            const button = document.createElement('button');
                            button.textContent = suggestion;
                            button.className = 'btn btn-secondary suggestion-button';
                            button.onclick = () => handleSuggestionClick(suggestion);
                            suggestionsDiv.appendChild(button);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading.classList.add('hidden');
                });
        }
        
    
        function handleSuggestionClick(suggestion) {
            console.log('Selected suggestion:', suggestion);
            fetchInstructions(analysisId, suggestion);
        }
    
        function fetchInstructions(analysisId, suggestion) {
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
    
            loading.classList.remove('hidden');
    
            const formData = new FormData();
            formData.append('food_analysis_id', analysisId);
            formData.append('food_choice_index', suggestion);
    
            fetch('https://ai-utu2.onrender.com/instructions', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    loading.classList.add('hidden');
    
                    resultsDiv.innerHTML += `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">Instructions</h5>
                                        <p>${data.instructions}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">Google Links</h5>
                                        ${data.GoogleSearch && data.GoogleSearch.length > 0 ? 
                                            data.GoogleSearch.map(item => `
                                                <a class="link text-primary d-block" href="${item.link}" target="_blank">${item.title}</a>
                                                <p>${item.description}</p>
                                            `).join('') : '<p>No Google links available.</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">YouTube Links</h5>
                                        ${data.YoutubeSearch && data.YoutubeSearch.length > 0 ? 
                                            data.YoutubeSearch.map(item => `
                                                <a class="link text-danger d-block" href="${item.link}" target="_blank">${item.title}</a>
                                            `).join('') : '<p>No YouTube links available.</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching instructions:', error);
                    loading.classList.add('hidden');
                });
        }
    </script>
    

</body>
</html>